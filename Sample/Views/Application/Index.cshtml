@model Sample.Models.AccountApplication
@{
    ViewData["Title"] = "Account Application";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<div class="container mt-4">
    <h2>Multi-Step Account Application</h2>
    <div id="progressBar" class="progress mb-3">
        <div id="progress" class="progress-bar" style="width: 20%"></div>
    </div>

    <form id="applicationForm" enctype="multipart/form-data">
        <input type="hidden" name="Id" value="@Model?.Id" />

        <div class="step step-1">
            <h5>Step 1: Account Details</h5>
            <select name="AccountType" class="form-control mb-2" required>
                <option value="">-- Select Account Type --</option>
                <option value="Individual" selected="@("Individual"==Model?.AccountType)">Individual</option>
                <option value="Company" selected="@("Company"==Model?.AccountType)">Company</option>
            </select>
            <button type="button" class="btn btn-primary next">Next</button>
        </div>

        <div class="step step-2 d-none">
            <h5>Step 2: Personal Information</h5>
            <input type="text" name="FirstName" class="form-control mb-2" placeholder="First Name" value="@Model?.FirstName" />
            <input type="text" name="LastName" class="form-control mb-2" placeholder="Last Name" value="@Model?.LastName" />
            <input type="email" name="Email" class="form-control mb-2" placeholder="Email" value="@Model?.Email" />
            <button type="button" class="btn btn-secondary prev">Back</button>
            <button type="button" class="btn btn-primary next">Next</button>
        </div>

        <div class="step step-3 d-none">
            <h5>Step 3: Contact Info</h5>
            <input type="text" name="Phone" class="form-control mb-2" placeholder="Phone" value="@Model?.Phone" />
            <textarea name="Address" class="form-control mb-2" placeholder="Address">@Model?.Address</textarea>
            <button type="button" class="btn btn-secondary prev">Back</button>
            <button type="button" class="btn btn-primary next">Next</button>
        </div>

        <div class="step step-4 d-none">
            <h5>Step 4: Upload Documents</h5>
            <input type="file" id="document" name="document" class="form-control mb-2" />
            <div id="preview"></div>
            <div class="progress mt-2">
                <div id="uploadProgress" class="progress-bar" style="width: 0%"></div>
            </div>
            <button type="button" class="btn btn-secondary prev">Back</button>
            <button type="button" class="btn btn-primary next">Next</button>
        </div>

        <div class="step step-5 d-none">
            <h5>Step 5: Review & Submit</h5>
            <p class="text-muted">This is the final step. Please review your details and click "Submit Application".</p>
            <button type="button" class="btn btn-secondary prev">Back</button>
            <button type="button" id="submitApp" class="btn btn-success">Submit Application</button>
        </div>
    </form>
</div>

<script>
    let currentStep = 1;
    const totalSteps = 5;
    let autoSaveInProgress = false;
    let autoSaveInterval;

    function showStep() {
        $(".step").addClass("d-none");
        $(`.step-${currentStep}`).removeClass("d-none");
        $("#progress").css("width", (currentStep / totalSteps * 100) + "%");
    }

    $(".next").click(() => {
        if (currentStep < totalSteps) {
            currentStep++;
            showStep();
        }
    });

    $(".prev").click(() => {
        if (currentStep > 1) {
            currentStep--;
            showStep();
        }
    });

    showStep();

    
    // autoSaveInterval = setInterval(() => {
    //     if (!autoSaveInProgress && currentStep < totalSteps) {
    //         autoSaveInProgress = true;
    //         saveDraft(true);
    //         autoSaveInProgress = false;
    //     }
    // }, 10000);

    function saveDraft(auto = false) {
        let formData = new FormData($("#applicationForm")[0]);
        $.ajax({
            url: '/Application/SaveDraft',
            type: 'POST',
            data: formData,
            contentType: false,
            processData: false,
            success: function (res) {
                if (res.id) $("input[name='Id']").val(res.id);
                if (!auto) {
                    alert("Draft saved successfully!");
                }
            }
        });
    }

    $("#submitApp").click(function () {
        let formData = new FormData($("#applicationForm")[0]);

        $.ajax({
            url: '/Application/SubmitApplication',
            type: 'POST',
            data: formData,
            contentType: false,
            processData: false,
            success: function (res) {
                if (res.success) {
                    clearInterval(autoSaveInterval); // stop auto-save
                    window.location.href = `/Application/Summary/${res.id}`;
                } else {
                    alert("Submission failed: " + res.message);
                }
            },
            error: function () {
                alert("Error submitting application.");
            }
        });
    });

    $("#document").on("change", function (e) {
        let file = e.target.files[0];
        if (file) $("#preview").html(`<p>${file.name}</p>`);
    });
</script>

